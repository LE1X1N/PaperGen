# 接口文档

当前服务对外提供两个接口：

- /v1/gen_figures
- /v1/progress/{request_id}
- /v1/health

## 1. 发送生成图片请求 

- **接口路径**：/v1/gen_figures 
- **接口类型**: POST
- **功能描述**：接收请求JSON，解析为多个子任务生成代码并渲染
- **参数**：
    - data: 对应的dict

示例请求：

``` bash
# 发送请求
curl -X POST http://localhost:8686/v1/gen_figures -H "Content-Type: application/json"  -d @docs/测试输入.json
```

如果成功，则会立马返回对应的任务ID号：

``` bash
# 成功响应, 其中  "3ca7c636-cd02-4f66-ab01-632431d95978" 即唯一请求ID

{
  "code": 0, 
  "message": "任务创建成功!", 
  "task_id": "20250813104545707549754_TASK_REPORT",
  "request_id": "3ca7c636-cd02-4f66-ab01-632431d95978"
}
```

## 2. 查询处理进度

- **接口路径**： /v1/progress/{request_id}
- **接口类型**： GET
- **功能描述**：基于任务ID号查询处理状态

```bash
# 示例请求，其中 "3ca7c636-cd02-4f66-ab01-632431d95978" 为对应的请求ID
curl http://localhost:8686/v1/progress/3ca7c636-cd02-4f66-ab01-632431d95978
```

返回结果如下所示。
对于每一个task对应输入JSON中的ID。
status包含三个状态： ["pending", "success", "failed"]

- **pending**： 任务正在处理中，此时url为空
- **success**: 任务处理完成，此时url对应生成页面，已上传至对应的文件系统中，可直接访问
- **failed**: 任务处理失败，此时url为空，额外error字段为错误信息。

``` bash

{
  "task_id": "20250813104545707549754_TASK_REPORT",
  "request_id": "3ca7c636-cd02-4f66-ab01-632431d95978",
  "create_time": "2025-08-13T16:35:22.811891",
  "total_tasks": 9,
  "tasks":  [
    {
      "id": "0",
      "status": "success",
      "url": "http://10.20.171.4:52003/fsdata/website/website.result/data/files/website.result/20250813/6a818c8491084f2099a416eb66e38f8b175507419064287802.png"
    },
    {
      "id": "1",
      "status": "success",
      "url": "http://10.20.171.4:52003/fsdata/website/website.result/data/files/website.result/20250813/36848860aa6049b8a6fb7fe0546dce7f175507419746068178.png"
    },
    {
      "id": "2",
      "status": "pending",
      "url": ""
    },
    {
      "id": "3",
      "status": "failed",
      "url": "",
      "error": "【任务失败】任务超过最大重试次数"
    },
    {
      "id": "4",
      "status": "pending",
      "url": ""
    },
    {
      "id": "5",
      "status": "success",
      "url": "http://10.20.171.4:52003/fsdata/website/website.result/data/files/website.result/20250813/50aaebfcbc2240b5a85e1db457a59560175507422444679919.png"
    },
    {
      "id": "6",
      "status": "pending",
      "url": ""
    },
    {
      "id": "7",
      "status": "pending",
      "url": ""
    },
    {
      "id": "8",
      "status": "failed",
      "url": "",
      "error": "【任务失败】任务超过最大重试次数"
    }
  ]
}

```


## 3. 检查服务状态

- **接口路径**： /v1/health
- **接口类型**： GET
- **功能描述**：查询服务状态

```bash
# 检查当前服务的状态
curl http://localhost:8687/v1/health
```

调用此接口将会触发服务状态检查，包括检查 OpenAI、Selenium、DFS以及MongoDB的连接状态。
- OpenAI：尝试向模型发送 "ping" 信息，等待模型回复，若正确得到返回则判断正常。 
- Selenium: 尝试获取一个Chrome Driver，若Driver正常初始化成功则判断正常。
- DFS：向配置文件当中的 dfs.health_check_url 发送查询状态信息，如返回无错误码则判断正常。
- MongoDB：连接MongoDB，并尝试读取数据库的条目数量，若能够正确返回条目数量则判断正常。


若依赖服务均无问题，对应响应为：


```json
{
  "code": 0, 
  "status": "healthy", 
  "service": "self-coder-service"
}
```

如果存在错误，则会返回错误状态码-1。

```json
{
  "code": -1, 
  "status": "error", 
  "service": "self-coder-service"
}
```
